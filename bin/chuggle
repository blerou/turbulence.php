#!/usr/bin/env php
<?php

if (empty($_SERVER['argv'][1]) || empty($_SERVER['argv'][2])) {
  die(PHP_EOL.'Usage: php chuggle.php TARGET_DIR REPOSITORY_BASE_DIR'.PHP_EOL.PHP_EOL);
}

$targetDir = realpath($_SERVER['argv'][1]);
$repoDir   = realpath($_SERVER['argv'][2]).'/';

$baseDir = __DIR__.'/../src/';
if (realpath($baseDir)) {
	set_include_path(get_include_path().PATH_SEPARATOR.$baseDir);
}
require 'paindriven/chuggle/Logger.php';
require 'paindriven/chuggle/Collector.php';
require 'paindriven/chuggle/ComplexityService.php';
require 'paindriven/chuggle/ChangesService.php';

use paindriven\chuggle\Logger;
use paindriven\chuggle\Collector;
use paindriven\chuggle\ComplexityService;
use paindriven\chuggle\ChangesService;


$logger = new Logger();
$result = new Collector();

$complexity = new ComplexityService($logger, $targetDir, $repoDir);
$result     = $complexity->calculate($result);
$changes    = new ChangesService($logger, $targetDir, $repoDir, $complexity->map());
$result     = $changes->calculate($result);

$logger->log('writing results...');
$outFile = get_temp_dir($targetDir).'/out.json';
$result->dumpJson($outFile);


function get_temp_dir($targetDir) {
  $tempDir   = '/tmp/'.preg_replace('/[^a-z0-9_-]/i', '_', $targetDir);
  if (!is_dir($tempDir)) {
    mkdir($tempDir);
  }

  return $tempDir;
}