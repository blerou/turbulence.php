#!/usr/bin/env php
<?php

register_autoloader();

use paindriven\chuggle\Logger;
use paindriven\chuggle\Collector;
use paindriven\chuggle\scm\Git;
use paindriven\chuggle\ComplexityService;
use paindriven\chuggle\ChangesService;


$params = parse_params($_SERVER['argv']);

$repoUrl    = $params['r'];
$outputDir  = rtrim($params['o'], '/');
$path       = $params['p'];
$repoDir    = $outputDir.'/_repo';
$subjectDir = $repoDir.'/'.$path;
$buildViewer = isset($params['v']);

$logger = new Logger();
$result = new Collector();

$logger->log('cloning git repo...');
$git = new Git();
$git->fetch($repoUrl, $repoDir);

$complexity = new ComplexityService($logger, $subjectDir, $repoDir, $outputDir);
$result     = $complexity->calculate($result);
$changes    = new ChangesService($git, $logger, $path, $repoDir, $complexity->map());
$result     = $changes->calculate($result);

$logger->log('writing results...');
$outFile = $outputDir.'/out.json';
$result->dumpJson($outFile);

if ($buildViewer) {
	$viewerFile = $outputDir.'/viewer.html';
	$templateDir = __DIR__.'/../viewer';
	$viewer = file_get_contents($templateDir.'/viewer.template.html');
	$viewer = strtr($viewer, array(
		'<*jquery.min.js*>'  => file_get_contents($templateDir.'/jquery.min.js'),
		'<*jquery.flot.js*>' => file_get_contents($templateDir.'/jquery.flot.js'),
		'<*json*>'           => file_get_contents($outFile),
	));
	file_put_contents($viewerFile, $viewer);

	$browser = $params['v'];
	if ($browser) {
		`{$browser} {$viewerFile}`;
	}
}


function register_autoloader() {
	$baseDir = __DIR__.'/../src/';
	if (realpath($baseDir)) {
		set_include_path(get_include_path().PATH_SEPARATOR.$baseDir);
	}
	spl_autoload_register(function($class) {
		if (0 === strpos($class, 'paindriven\\chuggle')) {
			require_once str_replace('\\', '/', $class).'.php';
			return class_exists($class, false) || interface_exists($class, false);
		}
		return false;
	});
}

function parse_params($args) {
	$params    = array();
	$usageText = <<<EOB

Usage: chuggle -r=REPOSITORY_BASE_URL -o=OUTPUT_DIR [-p=PATH_IN_THE_REPO] [-v[=BROWSER_COMMAND]]

Hints:
 -v : generate a viewer.html under OUTPUT_DIR to view result. if BROWSER_COMMAND setted, it launch the browser

EOB;
	foreach (array_slice($args, 1) as $arg) {
		if (!preg_match('/^-(r|p|o|v)=?(.*)$/', $arg, $match)) {
			die($usageText);
		}

		$params[$match[1]] = $match[2];
	}
	if (!isset($params['r']) || !isset($params['o'])) {
		die($usageText);
	}

	$params['p'] = isset($params['p']) ? ltrim($params['p'], '/') : '';

	return $params;
}